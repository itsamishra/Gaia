<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sub Node Dashboard</title>

    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <style>
        thead {
            text-align: center;
        }

        td,
        th {
            text-align: center;
            border: solid 1px black;
        }

        h3 {
            margin-left: 300px;
        }
    </style>
</head>

<body>
    <h1 style="text-align:center">Sub Node Dashboard</h1>

    <br /><br />

    <table class="striped">
        <thead>
            <tr>
                <th>IP</th>
                <th>Snapshot</th>
                <th>Battery Level (%)</th>
                <th>Port Usage</th>
                <th>Unix Timestamp</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody class="rows">
            <!-- Data inserted here -->
        </tbody>
    </table>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        // Adds row to table
        function addRow(ip, unixTimestamp, batteryPercentage, status, base64EncodedImage) {
            let row =
                `<tr><td>${ip}</td><td><img src="data:image/png;base64, ${base64EncodedImage}"></td><td>${batteryPercentage}</td><td>Port 123 - App XYZ<br/>Port 456 - App LMN</td><td>${unixTimestamp}</td><td>${status}</td></tr>`
            $(".rows").append(row);
        };

        // Removes all rows from table
        function deleteAllRows() {
            $(".rows").empty();
        };

        // Refreshed data in table
        function refreshTable() {
            // Deletes all current rows
            deleteAllRows();

            // Gets Sub Node info and uses it to repopulate table
            $.ajax({
                type: 'GET',
                crossDomain: true,
                dataType: 'json',
                url: "http://127.0.0.1:3000/getUpdate",
                success: function (jsondata) {
                    console.log("SUCCESS");
                    console.log(jsondata);

                    let subNodeJsonKeys = Object.keys(jsondata);

                    console.log("Keys:");
                    for (let i = 0; i < subNodeJsonKeys.length; i++) {
                        let key = subNodeJsonKeys[i];
                        console.log(key);

                        let base64Image = jsondata[key].Base64EncodedScreenshot;
                        base64Image = base64Image.replace(/ /gi, "+");
                        let ip = jsondata[key].IP;
                        let unixTimestamp = jsondata[key].UnixTimestamp;
                        let batteryPercentage = jsondata[key].BatteryLevelPercentage;

                        addRow(ip, unixTimestamp, batteryPercentage, "123", base64Image)
                    }
                },
                error: function () {
                    console.log("ERROR");
                }
            });
        }

        // Constantly refreshes table every 'n' seconds
        refreshTable();
        window.setInterval(function () {
            console.log("refreshTable() Called")
            refreshTable();
        }, 5000);
    </script>
</body>

</html>